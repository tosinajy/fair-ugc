{% extends 'base.html' %}

{% block title %}FairUGC | Creator Rate Calculator{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
    /* Freeform Flow for Content Types (Capsule Style) */
    .content-grid-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        max-height: 320px;
        overflow-y: visible; /* Changed to visible for tooltips */
        padding-right: 5px;
    }
    
    /* 4-Column Grid for Usage Rights */
    .usage-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); 
        gap: 12px;
    }

    /* Usage Card Styling */
    .usage-card {
        background: var(--bg-app);
        border: 1px solid var(--border-soft);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center; 
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        height: 100%;
    }
    
    .usage-card:hover {
        border-color: var(--primary);
        background: white;
        transform: translateY(-2px);
    }
    
    .usage-card.active {
        border-color: var(--primary);
        background: #e0e7ff; 
    }
    
    /* Dark mode specific for active state */
    body.dark-mode .usage-card.active {
        background: var(--primary-dark);
        color: white;
    }
    body.dark-mode .usage-card.active .row-title {
        color: white;
    }

    /* Toggle Switch inside Card */
    .usage-card .switch {
        margin-top: 10px;
        pointer-events: none; 
    }

    /* Tooltip Icon */
    .info-icon {
        position: absolute;
        top: 5px;
        right: 5px;
        color: var(--text-muted);
        font-size: 0.8rem;
        cursor: help;
        z-index: 10;
    }

    /* Disclaimer Text */
    .price-disclaimer {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-align: center;
        margin-top: 15px;
        font-style: italic;
        opacity: 0.8;
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
        .usage-grid {
            grid-template-columns: repeat(2, 1fr); 
        }
        .result-panel {
            display: none; /* Keep hidden on mobile, used in modal/footer logic */
        }
    }
    @media (max-width: 500px) {
        .usage-grid {
            grid-template-columns: 1fr; 
        }
    }
</style>
{% endblock %}

{% block content %}
<nav class="app-navbar">
    <div class="nav-content">
        <div class="nav-brand">
            <div class="logo-icon"><i class="fas fa-calculator"></i></div>
            <span class="brand-text">FairUGC</span>
        </div>
        <button class="theme-toggle-btn" id="themeToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
    </div>
</nav>

<div class="main-container">
    
    <!-- LEFT PANEL: HERO + WIZARD -->
    <div class="input-panel">
        
        <!-- COMPACT HERO INTRO -->
        <div class="hero-content">
            <h1 class="hero-title">Stop Guessing Your Worth.</h1>
            <p class="hero-subtitle">
                Generate data-backed rate cards for UGC, content creation, and influencer partnerships instantly.
            </p>
        </div>

        <form id="calcForm" class="wizard-form">
            <!-- Step 1: Content Type (Mixed Bundles) -->
            <div class="wizard-step">
                <div class="step-header">
                    <span class="step-badge">1</span>
                    <span class="step-label">Content Types (Select Multiple)</span>
                </div>
                <div class="step-body">
                    <div class="content-grid-wrapper">
                        {% for rate in base_rates %}
                        <div class="type-pill {{ 'active' if loop.first else '' }}" 
                             data-value="{{ rate.slug }}"
                             data-content="{{ rate.description }}"
                             data-position="top center"
                             data-variation="inverted">
                            
                            <div class="pill-text">
                                <span class="title">{{ rate.name }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="helper-text" style="text-align: center; margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> Combine multiple items to create a mixed bundle.
                    </div>
                </div>
            </div>

            <!-- Step 2: Niche (Dynamic) -->
            <div class="wizard-step">
                <div class="step-header">
                    <span class="step-badge">2</span>
                    <span class="step-label">Brand Niche</span>
                </div>
                <div class="step-body">
                    <select id="nicheSelect" placeholder="Select industry..." autocomplete="off">
                        {% for niche in niches %}
                        <!-- Item text only, no icons in option text -->
                        <option value="{{ niche.slug }}">{{ niche.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Step 3: Experience (Dynamic) -->
            <div class="wizard-step">
                <div class="step-header">
                    <span class="step-badge">3</span>
                    <span class="step-label">Creator Level</span>
                </div>
                <div class="step-body">
                    <div class="segmented-control">
                        {% for exp in experiences %}
                        <button type="button" class="segment-btn {{ 'active' if loop.first else '' }}" 
                                data-value="{{ exp.slug }}"
                                data-desc="{{ exp.description }}">
                            <span class="seg-label">{{ exp.name }}</span>
                            <span class="seg-sub">{{ exp.years_range }}</span>
                        </button>
                        {% endfor %}
                    </div>
                    <div class="helper-text" id="expDetail">
                        <i class="fas fa-info-circle"></i> 
                        {{ experiences[0].description if experiences else 'Select a level' }}
                    </div>
                </div>
            </div>

            <!-- Step 4: Usage Rights (Grid Layout) -->
            <div class="wizard-step">
                <div class="step-header">
                    <span class="step-badge">4</span>
                    <span class="step-label">Usage Rights (Select One)</span>
                </div>
                <div class="step-body">
                    <div class="usage-grid">
                        {% for usage in usage_rights %}
                        <div class="usage-card {{ 'premium-border' if usage.is_premium else '' }}"
                             data-target-slug="{{ usage.slug }}"
                             data-content="{{ 'Multiplier: ' ~ usage.multiplier ~ 'x - ' ~ (usage.name) }}" 
                             data-position="top center"
                             data-variation="inverted">
                                                         
                            <div class="row-info" style="margin-bottom: 5px;">
                                <span class="row-title" style="font-size: 0.8rem; display: block; line-height: 1.2;">{{ usage.name }}</span>
                                <span class="row-badge {{ 'premium' if usage.is_premium else '' }}" style="font-size: 0.7rem; margin-top: 4px; display: inline-block;">
                                    +{{ (usage.multiplier * 100)|int }}%
                                </span>
                            </div>
                            
                            <div class="switch">
                                <!-- Changed type to radio for single select behavior logic -->
                                <input type="radio" name="usage" value="{{ usage.slug }}" id="cb_{{ usage.slug }}">
                                <span class="slider round"></span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- RIGHT PANEL: RESULTS -->
    <div class="result-panel">
        <div class="sticky-wrapper">
            <div class="quote-card">
                <div class="price-section">
                    <div class="price-label">Fair Market Range</div>
                    <div class="price-value">
                        <span class="currency">$</span><span id="minPrice">...</span>
                        <span class="separator">â€“</span>
                        <span class="currency">$</span><span id="maxPrice">...</span>
                    </div>
                    <div class="price-context">
                        Based on <strong>32k+ data points</strong> matching your specific niche & experience.
                    </div>
                </div>

                <!-- Gated Breakdown Section -->
                <div class="breakdown-container-wrapper">
                    <div id="breakdownOverlay" class="unlock-overlay">
                        <div class="lock-icon"><i class="fas fa-lock"></i></div>
                        <p>Unlock detailed cost breakdown & formal PDF quote.</p>
                        <button class="btn-unlock trigger-modal">Unlock Full Report</button>
                    </div>
                    
                    <div id="breakdownContent" class="breakdown-content blur-content">
                        <div class="breakdown-row">
                            <span>Base Rate (Sum)</span>
                            <span id="bdBase">$...</span>
                        </div>
                        <div class="breakdown-row sub" id="bdTypesList" style="font-size: 0.8rem; font-style: italic;"></div>

                        <div class="breakdown-row sub">
                            <span>Niche Multiplier</span>
                            <span id="bdNiche">x...</span>
                        </div>
                        <div class="breakdown-row sub">
                            <span>Experience Multiplier</span>
                            <span id="bdExp">x...</span>
                        </div>
                        <div class="divider-dashed"></div>
                        <div id="bdUsageContainer"></div>
                        <div class="breakdown-row total">
                            <span>Calculated Total</span>
                            <span id="bdTotal">$...</span>
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="btn-pitch" id="generatePitchBtn">
                        <i class="fas fa-magic"></i> Generate Pitch
                    </button>
                    <button class="btn-download trigger-modal" id="downloadQuoteBtn">
                        <i class="fas fa-file-pdf"></i> Download PDF Quote
                    </button>
                </div>
                
                <!-- Disclaimer -->
                <div class="price-disclaimer">
                    *Estimates are for reference only. Actual rates may vary based on specific deliverables.
                </div>
            </div>

            <div id="pitchPanel" class="pitch-container hidden">
                <div class="pitch-head">
                    <h4>Pitch Draft</h4>
                    <button class="close-pitch" id="closePitchBtnTop"><i class="fas fa-times"></i></button>
                </div>

                <div class="pitch-controls">
                    <div class="ui selection dropdown" id="moodDropdown">
                        <input type="hidden" id="pitchMood" value="professional">
                        <i class="dropdown icon"></i>
                        <div class="text">Professional</div>
                        <div class="menu">
                            <div class="item" data-value="professional">Professional</div>
                            <div class="item" data-value="casual">Casual</div>
                            <div class="item" data-value="bold">Bold</div>
                        </div>
                    </div>
                    <button class="ui button" id="refreshPitchBtn">
                        <i class="sync icon"></i> Change Copy
                    </button>
                </div>

                <textarea id="pitchText" readonly spellcheck="false"></textarea>
                <button class="btn-copy" id="copyPitchBtn">Copy to Clipboard</button>
                <!-- <button class="ui button basic fluid mini" style="margin-top:10px;" id="dismissPitchBtn">Dismiss</button> -->
            </div>
        </div>
    </div>
</div>

<!-- Updated Mobile Footer -->
<div class="mobile-footer">
    <div class="footer-info">
        <span class="footer-label">Range</span>
        <span class="footer-val">$<span id="mobileMin">...</span> - $<span id="mobileMax">...</span></span>
    </div>
    <div style="display:flex; gap:8px;">
        <button class="footer-btn secondary" id="mobileGeneratePitchBtn" style="background:#e0e7ff; color:var(--primary);">
            <i class="fas fa-magic"></i>
        </button>
        <button class="footer-btn trigger-modal">
            <i class="fas fa-lock"></i> Breakdown
        </button>
    </div>
</div>

<div class="ui tiny modal" id="leadModal">
    <i class="close icon"></i> <!-- Semantic UI Close Icon -->
    <div class="header">Unlock Your Professional Quote</div>
    <div class="content">
        <div class="modal-body">
            <div class="modal-icon">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <h3>Where should we send your quote?</h3>
            <p>Enter your email to unlock the detailed price breakdown and download your PDF instantly.</p>
            <form id="leadForm" class="ui form">
                <div class="field">
                    <div class="ui left icon input large">
                        <i class="mail icon"></i>
                        <input type="email" name="email" id="leadEmail" placeholder="name@example.com" required>
                    </div>
                </div>
                <div class="ui error message"></div>
                <button type="submit" class="ui button fluid huge primary" id="submitLeadBtn">
                    Unlock Results
                </button>
            </form>
            <div class="modal-trust">
                <i class="lock icon"></i> No spam. Unsubscribe anytime.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
         const $ = window.jQuery;
         if ($) {
             $('.ui.dropdown').dropdown();
             // Initialize popups targeting data-content
             $('[data-content]').popup({
                 on: 'hover',
                 variation: 'inverted',
                 position: 'top center',
                 delay: { show: 100, hide: 0 }
             });
         }

         const segmentBtns = document.querySelectorAll('.segment-btn');
         const expDetail = document.getElementById('expDetail');
         
         segmentBtns.forEach(btn => {
             btn.addEventListener('click', () => {
                 const desc = btn.getAttribute('data-desc');
                 if(desc) expDetail.innerHTML = `<i class="fas fa-info-circle"></i> ${desc}`;
             });
         });

         const refreshBtn = document.getElementById('refreshPitchBtn');
         const genBtn = document.getElementById('generatePitchBtn');
         if(refreshBtn && genBtn) {
             refreshBtn.addEventListener('click', (e) => {
                 e.preventDefault();
                 genBtn.click(); 
             });
         }
         
         // Logic for Usage Cards Grid (Single Select)
         const usageCards = document.querySelectorAll('.usage-card');
         usageCards.forEach(card => {
             card.addEventListener('click', (e) => {
                 if(e.target.classList.contains('info-icon')) return;
                 
                 const slug = card.dataset.targetSlug;
                 const checkbox = document.getElementById('cb_' + slug);
                 const wasChecked = checkbox.checked;

                 // Uncheck all others
                 document.querySelectorAll('input[name="usage"]').forEach(cb => {
                     cb.checked = false;
                     // Remove active class from parent card
                     cb.closest('.usage-card').classList.remove('active');
                 });

                 // Toggle current (allow deselect if it was already checked, or force select)
                 // Requirement 6 says "Select only one". Often implies one MUST be selected, 
                 // but typically toggle behavior is user friendly. Let's make it strict single select.
                 if (!wasChecked) {
                     checkbox.checked = true;
                     card.classList.add('active');
                 }
                 
                 const event = new Event('change');
                 checkbox.dispatchEvent(event);
             });
         });
         
         // Close Modal logic via icon is handled by Semantic UI automatically if class="close icon" is inside modal
    });
</script>
{% endblock %}